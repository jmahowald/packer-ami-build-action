name: Packer Build
on:
  pull_request: 
    paths-ignore:
    - 'test/deriv**'
    - '.github/workflows/test-derivative.yml'
jobs:
  packer-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: generate random image id
      run: |
        image_id=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13 ; echo '')
        cat > test/derivate-vars.json <<EOL
        {
          "parent_image_id": "ami-0a34edf50d75afa42",
          "random_image_id": "$image_id"
        }
        EOL
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v1.5.2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMIT_MESSAGE: Update image id for derivatives
        COMMIT_AUTHOR_EMAIL: jmahowald@users.noreply.github.com
        COMMIT_AUTHOR_NAME: Josh Mahowald
        PULL_REQUEST_TITLE: '[AMI Info] Image ID'
        PULL_REQUEST_BODY: >
          This PR is auto-generated by 
          [create-pull-request](https://github.com/peter-evans/create-pull-request).
        PULL_REQUEST_LABELS: ami, auto pr
        PULL_REQUEST_ASSIGNEES: jmahowald
        BRANCH_SUFFIX: short-commit-hash

